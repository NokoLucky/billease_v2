default_platform(:ios)

platform :ios do
  desc "Deploy to TestFlight"
  lane :deploy do
    # Setup match with API key
    setup_travis
    
    # Create app store certificate and provisioning profile
    match(
      type: "appstore",
      app_identifier: "com.billease.app.UNC2YV5NU9",
      api_key: app_store_connect_api_key
    )

    # Build the app
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      clean: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      api_key: app_store_connect_api_key
    )
  end

  def app_store_connect_api_key
    {
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY'],
      is_key_content_base64: false,
      duration: 1200,
      in_house: false
    }
  end
end